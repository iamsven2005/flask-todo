<!DOCTYPE html>
<html>
<head>
  <title>ToDo Login</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; }
    #todoArea { display: none; }
  </style>
</head>
<body>
  <div id="loginArea">
    <h3>Login</h3>
    <input id="username" placeholder="Enter username">
    <button onclick="login()">Login</button>
  </div>

  <div id="todoArea">
    <h3>Your ToDo List</h3>
    <input id="taskInput" placeholder="New task">
    <button onclick="addTask()">Add</button>
    <br><br>
    <input id="searchInput" placeholder="Search..." oninput="filterTasks()">
    <ul id="taskList"></ul>
    <br>
    <button onclick="logout()">Logout</button>
  </div>

  <script>
    let allTasks = [];

    async function login() {
      const username = document.getElementById('username').value;
      await fetch('/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username })
      });
      document.getElementById('loginArea').style.display = 'none';
      document.getElementById('todoArea').style.display = 'block';
      loadTasks();
    }

    async function logout() {
      await fetch('/logout');
      document.getElementById('loginArea').style.display = 'block';
      document.getElementById('todoArea').style.display = 'none';
      allTasks = [];
    }

    async function addTask() {
      const task = document.getElementById('taskInput').value;
      await fetch('/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ task })
      });
      document.getElementById('taskInput').value = '';
      loadTasks();
    }

    async function loadTasks() {
      const res = await fetch('/list');
      allTasks = await res.json();
      renderTasks(allTasks);
    }

    function renderTasks(tasks) {
      const list = document.getElementById('taskList');
      list.innerHTML = '';
      tasks.forEach(([id, task]) => {
        const li = document.createElement('li');
        li.textContent = task;
        list.appendChild(li);
      });
    }

    function filterTasks() {
      const query = document.getElementById('searchInput').value.toLowerCase();
      const filtered = allTasks.filter(([id, task]) => task.toLowerCase().includes(query));
      renderTasks(filtered);
    }
  </script>
</body>
</html>
